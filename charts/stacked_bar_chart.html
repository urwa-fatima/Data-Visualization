<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta Region="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />

    <link href="https://fonts.googleapis.com/css?family=Open+Sans" rel="stylesheet">
    <script src="https://d3js.org/d3.v6.js"></script>
    <title>Group Avatar: Multiple Stacked Barchart with D3.js</title>
</head>
<style>
    .line-vertical {
        position: absolute;

        width: 2px;
        /* line-width */
        height: 25px;
        /* line length */
        margin-left: 110px;
        margin-top: 85px;
        float: left;
        background: #aaa;
        z-index: 100;
    }

    .arrow-up:after {
        content: "";
        position: absolute;
        z-index: 100;
        width: 0px;
        height: 0px;
        border: 5px solid transparent;
        top: -10px;
        border-bottom: 15px solid #aaa;
        left: -4px;
    }

    .info {
        position: absolute;
        z-index: 100;
        text-align: center;
        margin-left: 67px;
        margin-top: 55px;
        font-size: 12px
    }
</style>

<body>
    <div class="graph_center">
        <h1>The Stacked Barchart with Small Multiple Neighborhood Vs Tree Type</h1>
    </div>
    <div style="position: absolute;" id="my_dataviz"></div>


    <script type="text/javascript">
        var tooltip = d3.select("#my_dataviz")
            .append("div")
            .attr("class", "toolTip")
            .style("display", "none");

        var margin = { top: 80, right: 30, bottom: 0, left: 130 },
            width = 350 - margin.left - margin.right,
            height = 800 - margin.top - margin.bottom;
        chartWidth = width;
        chartHeight = 600;
        
        // Parse the Data
        d3.csv("../data/map_data_stacked.csv").then(function (data) {
            var mycolors = ['#66976B', '#1D382B', '#D68C2C', '#A54A2B',
                '#C7A98C', '#53070D', '#364277', '#C5BE6A', '#B7264A', '#F4A6B3',
                '#8FBFCC', '#226D7B', '#002E6B'];

            var column_name = data.columns.slice(1);
            data.new_columns = convertDataColumns()
            console.log(data)

            var color = d3.scaleOrdinal()
                .domain(column_name)
                .range(mycolors);

            for (var i = 1; i < column_name.length + 1; i++) {
                if (i > 1) {
                    margin = { top: 80, right: 30, bottom: 30, left: 30 },
                        width = 220 - margin.left - margin.right,
                        height = 800 - margin.top - margin.bottom;
                    chartWidth = width;
                    chartHeight = 600;
                }

                if (i >= column_name.length - 1) {
                    margin = { top: 80, right: 30, bottom: 30, left: 30 },
                        width = 225 - margin.left - margin.right,
                        height = 800 - margin.top - margin.bottom;
                    chartWidth = width;
                    chartHeight = 600;
                }
                // append the svg object to the body of the page
                const svg = d3.select("body")
                    .append("svg")
                    .attr("width", width + margin.left + margin.right)
                    .attr("height", height + margin.top + margin.bottom)
                    .append("g")
                    .attr("transform", `translate(${margin.left}, ${margin.top})`)

                var region = data.map(function (d) { return d.Regions; });

                var keys = [data.columns[i]];

                var stack = d3.stack()
                    .keys(keys)
                    .order(d3.stackOrderNone)
                    .offset(d3.stackOffsetNone);

                var series = stack(data);
                // Add X axis
                const x = d3.scaleLinear()
                    .domain([0, d3.max(data, function (d) {
                        return d3.sum(keys, function (key) {
                            return +d[key];
                        });
                    })])
                    .range([0, chartWidth]);

                svg.append("g")
                    .attr("transform", `translate(0, ${chartHeight})`)
                    .call(d3.axisBottom(x))
                    .selectAll("text")
                    .attr("transform", "translate(-10,0)rotate(-45)")
                    .style("text-anchor", "end");
                const y = d3.scaleBand()
                    .range([0, chartHeight])
                    .domain(data.map(d => d.location))
                    .padding(.2);

                if (i == 1) {
                    svg.append("g")
                        .call(d3.axisLeft(y))
                } else {
                    var y_2 = d3.scaleBand()
                        .range([0, chartHeight])
                    svg.append("g")
                        .call(d3.axisLeft(y_2))
                        .style("stroke-dasharray", "5 5")
                        .attr("transform", "translate(-20, 0)")
                }

                //Bars
                svg.selectAll("g.stack")
                    .data(series)
                    .enter().append("g")
                    .attr("class", "stack")
                    .attr("fill", function (d) { return color(d.key); })
                    .attr("class", function (d) { return d.key })
                    .selectAll("rect")
                    .data(function (d) { return d; })
                    .enter().append("rect")
                    .attr("class", function (d) { return d.data.location })
                    .attr("y", function (d) { return y(d.data.location); })
                    .attr("x", function (d) { return x(d[0]); })
                    .attr("height", y.bandwidth())
                    .attr("width", function (d) { return x(d[1]) - x(d[0]); })
                    .on("mousemove", function (d) {

                        tooltip
                            .style("left", d.pageX - 50 + "px")
                            .style("top", d.pageY - 70 + "px")
                            .style("display", "inline-block")
                    })
                    .on("mouseout", function (d) { tooltip.style("display", "none"); });

                //Legend
                console.log(data.new_columns[i])
                var legend = svg.selectAll(".legend")
                    .data(data.new_columns[i - 1])
                    .enter().append("g")
                    .attr("font-family", "sans-serif")
                    .attr("font-size", 12)
                    .attr("class", "legend")
                    .attr("transform", function (d, i) { return "translate(0," + i * 40 + ")"; });

                legend.append("text")
                    .attr("x", width - 70)
                    .attr("y", -35)
                    .attr("dy", ".35em")
                    .style("text-anchor", "middle")
                    .style("alignment-baseline", "middle")
                    .style("font-weight", "bold")
                    .text(function (d) { return (d.info) })
                legend.append("text")
                    .attr("x", width - 70)
                    .attr("y", -15)
                    .attr("dy", ".35em")
                    .style("fill", "grey")
                    .style("text-anchor", "middle")
                    .style("alignment-baseline", "middle")
                    .text(function (d) { return (d.date) })

            }

            function convertDataColumns() {
                return [
                    [{ "info": "Initial period", "date": "01/01/20-30/06/20" }],
                    [{ "info": "Second wave", "date": "01/07/20-30/09/20" }],
                    [{ "info": "Third wave", "date": "01/10/20-31/03/21" }],
                    [{ "info": "Spring/Summer 2021", "date": "01/04/21-30/07/21" }],
                    [{ "info": "Fourth period", "date": "01/08/21-30/11/21" }],
                    [{ "info": "Fifth period", "date": "01/12/21-24/12/22" }],

                ]
            }
        })


    </script>
    <div class="container">
        <div class="line-vertical arrow-up"></div>
        <div class="info">ordered by <br><strong>population density</strong></div>
        <p style="margin-left: 3%">
            Share of positive COVID-19 to deaths per country
        </p>
    </div>

</body>


</html>